<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω–∞—è –∫–∞–ø—Å—É–ª–∞ –≤—Ä–µ–º–µ–Ω–∏ ¬∑ –ü—Ä–µ—Ñ–∏–∫—Å—ã+</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }

        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --text: #0f172a;
            --text-light: #475569;
            --border: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.02);
            --radius: 1rem;
            --radius-sm: 0.75rem;
            --error: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --toast-bg: #1e293b;
            --toast-text: #f8fafc;
            --prefix-bg: #f59e0b;
            --prefix-text: #000;
        }

        body.dark {
            --bg: #0f172a;
            --surface: #1e293b;
            --primary: #818cf8;
            --primary-light: #a5b4fc;
            --text: #f1f5f9;
            --text-light: #cbd5e1;
            --border: #334155;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
            --toast-bg: #334155;
            --prefix-bg: #fbbf24;
            --prefix-text: #000;
        }

        body {
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            transition: background 0.2s;
        }

        #app {
            width: 100%;
            max-width: 1400px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø */
        .auth-screen {
            max-width: 400px;
            margin: 4rem auto;
            padding: 2rem;
            text-align: center;
        }
        .auth-screen h1 {
            margin-bottom: 2rem;
            color: var(--primary);
        }
        .auth-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            margin-bottom: 1rem;
            background: var(--surface);
            color: var(--text);
        }
        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: 0.2s;
        }
        .btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .btn-outline:hover {
            background: var(--primary-light);
            color: white;
        }
        .btn-sm {
            padding: 0.4rem 1rem;
            font-size: 0.9rem;
        }

        /* –®–ê–ü–ö–ê */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--surface);
            border-bottom: 2px solid var(--border);
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .user-name {
            background: var(--bg);
            padding: 0.4rem 1.2rem;
            border-radius: 40px;
            font-weight: 500;
            color: var(--text);
        }

        /* –û–°–ù–û–í–ù–û–ô –õ–≠–ô–ê–£–¢ */
        .main-content {
            display: flex;
            min-height: 70vh;
        }
        .groups-sidebar {
            width: 280px;
            background: var(--bg);
            padding: 1.5rem;
            border-right: 2px solid var(--border);
        }
        .groups-sidebar h3 {
            margin-bottom: 1rem;
            color: var(--text-light);
        }
        .group-list {
            list-style: none;
            margin-bottom: 2rem;
        }
        .group-item {
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            background: var(--surface);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .group-item:hover {
            border-color: var(--primary-light);
            background: #f1f5f9;
        }
        body.dark .group-item:hover {
            background: #334155;
        }
        .group-item.active {
            background: var(--primary);
            color: white;
        }
        .group-actions {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        /* –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ */
        .group-details {
            flex: 1;
            padding: 2rem;
            background: var(--surface);
            overflow-y: auto;
        }
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .group-title h2 {
            font-size: 2rem;
            color: var(--text);
        }
        .members-list {
            background: var(--bg);
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        .members-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        .member-tag {
            background: var(--primary-light);
            color: white;
            padding: 0.2rem 1rem;
            border-radius: 40px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }
        .action-buttons {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        /* –ö–ê–ü–°–£–õ–´ */
        .search-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .search-bar input {
            flex: 1;
            padding: 0.6rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface);
            color: var(--text);
        }
        .capsules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .capsule-card {
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: 1.2rem;
            border: 1px solid var(--border);
            position: relative;
        }
        .capsule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .capsule-header h4 {
            font-size: 1.2rem;
            color: var(--text);
            margin-right: auto;
        }
        .capsule-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        .capsule-author {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .capsule-date {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .capsule-actions {
            display: flex;
            gap: 0.3rem;
            margin-left: 0.5rem;
        }
        .capsule-actions button {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            cursor: pointer;
            color: var(--text);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .capsule-actions button:hover {
            background: var(--primary-light);
            color: white;
        }
        .capsule-media {
            margin: 1rem 0;
            max-height: 200px;
            text-align: center;
        }
        .capsule-media img,
        .capsule-media video {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: var(--radius-sm);
        }
        .capsule-caption {
            color: var(--text);
            font-style: italic;
            margin-bottom: 0.5rem;
        }
        .comments-section {
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            padding-top: 0.8rem;
        }
        .comment {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        .comment-author {
            font-weight: bold;
            color: var(--primary);
        }
        .comment-input {
            display: flex;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }
        .comment-input input {
            flex: 1;
            padding: 0.3rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface);
            color: var(--text);
        }

        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal h3 {
            margin-bottom: 1.5rem;
            color: var(--text);
        }
        .modal-form input,
        .modal-form textarea,
        .modal-form select {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface);
            color: var(--text);
        }
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        .flex-row {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .text-small {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        .multiline-hint {
            font-size: 0.85rem;
            color: var(--primary);
            margin-top: -0.5rem;
            margin-bottom: 1rem;
        }

        /* –¢–û–°–¢–´ */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 2000;
        }
        .toast {
            background: var(--toast-bg);
            color: var(--toast-text);
            padding: 0.8rem 1.2rem;
            border-radius: var(--radius-sm);
            margin-top: 0.5rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            animation: slideIn 0.2s;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--error); }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }
        .confirm-overlay.active { display: flex; }
        .confirm-box {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 400px;
            text-align: center;
        }

        hr { margin: 1rem 0; border-color: var(--border); }
        .empty-state { text-align: center; padding: 2rem; color: var(--text-light); }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ */
        .prefix-badge {
            background-color: var(--prefix-bg);
            color: var(--prefix-text);
            font-weight: bold;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
            margin-right: 0.3rem;
            line-height: 1.2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .member-tag .prefix-badge {
            background-color: rgba(255,255,255,0.3);
            color: inherit;
        }
        .capsule-author .prefix-badge {
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
        }
        .prefix-select {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface);
            color: var(--text);
        }
    </style>
</head>
<body>
<div id="app"></div>

<script>
    (function() {
        // ---------- –ö–û–ù–°–¢–ê–ù–¢–´ ----------
        const STORAGE_KEY = 'familyCapsuleFinalV7';
        const CURRENT_USER_KEY = 'currentUserId';
        const THEME_KEY = 'theme';
        const MAX_BULK_CAPSULES = 50;

        // ---------- –°–û–°–¢–û–Ø–ù–ò–ï ----------
        let state = { users: [], groups: [] };
        let currentUserId = null;
        let currentGroupId = null;
        let theme = localStorage.getItem(THEME_KEY) || 'light';
        if (theme === 'dark') document.body.classList.add('dark');

        // ---------- –£–¢–ò–õ–ò–¢–´ ----------
        const generateId = () => Date.now() + Math.random().toString(36).substring(2);
        const generateJoinCode = () => {
            let code;
            do { code = Math.random().toString(36).substring(2, 8).toUpperCase(); } 
            while (state.groups.some(g => g.joinCode === code));
            return code;
        };

        // ---------- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML ----------
        const escapeHtml = (unsafe) => {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        // ---------- –ó–ê–ì–†–£–ó–ö–ê/–°–û–•–†–ê–ù–ï–ù–ò–ï ----------
        const loadData = () => {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try { state = JSON.parse(stored); } 
                catch { initDemoData(); }
            } else initDemoData();
        };
        const saveData = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

        // ---------- –î–ï–ú–û-–î–ê–ù–ù–´–ï (—Å createdBy –∏ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏) ----------
        const initDemoData = () => {
            const user1 = { id: generateId(), name: '–ê–Ω–Ω–∞', password: '111' };
            const user2 = { id: generateId(), name: '–ò–≤–∞–Ω', password: '111' };
            const groupId = generateId();
            const demoImage = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\' viewBox=\'0 0 200 200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%234f46e5\'/%3E%3Ctext x=\'50\' y=\'115\' font-size=\'20\' fill=\'white\' font-family=\'Arial\'%3Eüì∏ –°–µ–º—å—è%3C/text%3E%3C/svg%3E';
            state = {
                users: [user1, user2],
                groups: [{
                    id: groupId,
                    name: '–ù–∞—à–∞ —Å–µ–º—å—è',
                    description: '–û–±—â–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è',
                    joinCode: 'ABC123',
                    createdBy: user1.id, // —Å–æ–∑–¥–∞—Ç–µ–ª—å
                    members: [user1.id, user2.id],
                    prefixes: ['üë® –ü–∞–ø–∞', 'üë© –ú–∞–º–∞', 'üëß –î–æ—á—å', 'üë¶ –°—ã–Ω'], // –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã
                    userPrefixes: {
                        [user1.id]: 'üë© –ú–∞–º–∞',
                        [user2.id]: 'üë® –ü–∞–ø–∞'
                    },
                    capsules: [{
                        id: generateId(),
                        title: '–û—Ç–ø—É—Å–∫ 2024',
                        caption: '–§–æ—Ç–æ —Å –º–æ—Ä—è',
                        mediaType: 'image',
                        mediaData: demoImage,
                        createdAt: new Date().toISOString(),
                        createdBy: user1.id,
                        comments: []
                    }]
                }]
            };
            saveData();
        };

        // ---------- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ----------
        const findUser = (name, password) => {
            return state.users.find(u => u.name.toLowerCase() === name.trim().toLowerCase() && u.password === password);
        };
        const createUser = (name, password) => {
            const newUser = { id: generateId(), name: name.trim(), password };
            state.users.push(newUser);
            saveData();
            return newUser;
        };
        const getUser = id => state.users.find(u => u.id === id);

        // ---------- –¢–û–°–¢–´ ----------
        const toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container';
        document.body.appendChild(toastContainer);
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `${message} <i class="fas fa-times" style="cursor:pointer;"></i>`;
            toastContainer.appendChild(toast);
            toast.querySelector('.fa-times').addEventListener('click', () => toast.remove());
            setTimeout(() => toast.remove(), 4000);
        }

        // ---------- –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï ----------
        const confirmOverlay = document.createElement('div');
        confirmOverlay.className = 'confirm-overlay';
        document.body.appendChild(confirmOverlay);
        function confirmAction(message) {
            return new Promise(resolve => {
                confirmOverlay.innerHTML = `
                    <div class="confirm-box">
                        <p>${message}</p>
                        <div class="modal-actions">
                            <button class="btn-outline" id="confirmNo">–ù–µ—Ç</button>
                            <button class="btn" id="confirmYes">–î–∞</button>
              
